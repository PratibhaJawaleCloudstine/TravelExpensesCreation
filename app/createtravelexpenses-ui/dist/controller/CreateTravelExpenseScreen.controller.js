sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/unified/FileUploader","sap/m/Dialog","sap/m/Button"],(e,t,n,s)=>{"use strict";return e.extend("createtravelexpenses.createtravelexpensesui.controller.CreateTravelExpenseScreen",{onInit(){this.getOwnerComponent().getRouter().getRoute("CreateTravelExpenseScreen").attachPatternMatched(this._onRouteMatched,this);const e={expenses:[],expenseTypes:[{key:"Meals/Snacks",text:"Meals/Snacks"},{key:"Air Travel",text:"Air Travel"},{key:"Laundry",text:"Laundry"},{key:"Rail Travel",text:"Rail Travel"},{key:"Road Travel",text:"Road Travel"},{key:"Alcohol",text:"Alcohol"}]};const t=new sap.ui.model.json.JSONModel(e);this.getOwnerComponent().setModel(t,"expenseModel");const n=new sap.ui.model.json.JSONModel({actionTaken:""});this.getOwnerComponent().setModel(n,"actionModel")},onAddNewExpense:function(){this.byId("expenseTable").setVisible(true);const e=this.getOwnerComponent().getModel("expenseModel");const t=e.getProperty("/expenses")||[];t.push({expenseType:"",receiptAmount:"",receiptDate:"",attachmentCount:"0",attachments:[]});e.setProperty("/expenses",t);console.log(t)},onEnterReceipts:function(){this.byId("idReceiptEntry").setVisible(true)},onDeleteSelectedExpenses:function(){const e=this.byId("expenseTable");const t=this.getOwnerComponent().getModel("expenseModel");const n=t.getProperty("/expenses")||[];const s=e.getSelectedContexts();if(s.length===0){sap.m.MessageToast.show("Please select at least one entry to delete.");return}const o=s.map(t=>e.getItems().indexOf(t.getObject()));const a=n.filter((e,t)=>!s.some(e=>e.getObject()===n[t]));t.setProperty("/expenses",a);e.removeSelections();const r=t.getProperty("/expenses")||[];const i=r.length>0;this.byId("expenseTable").setVisible(i)},onPreviousStep:function(){var e=sap.ui.core.routing.History.getInstance();var t=e.getPreviousHash();if(t!==undefined){window.history.go(-1)}else{this.getOwnerComponent().getRouter().navTo("RouteReviewTravelRequestScreen",true)}},onReviewTravelRequest:function(){const e=this.getOwnerComponent().getModel("expenseModel");const t=e.getProperty("/expenses")||[];const n=this.getOwnerComponent().getModel("actionModel");n.setProperty("/actionTaken","review");console.log("Review expenses");console.log(t);if(t.length>0){this.getOwnerComponent().getRouter().navTo("ReviewTravelExpensesScreen",{travelId:this.travelId})}else{sap.m.MessageToast.show("Please add Travel Expenses.")}},onSaveDraft:function(){const e=this.getOwnerComponent().getModel("expenseModel");const t=e.getProperty("/expenses")||[];const n=this.getOwnerComponent().getModel("actionModel");n.setProperty("/actionTaken","save");console.log("Save expenses");console.log(t);if(t.length>0){t.forEach(e=>{console.log("item");console.log(e);var t=this.getOwnerComponent().getModel();var n=t.bindList("/TravelExpenses",undefined,undefined,undefined,{$$updateGroupId:"travelExpensesGroup"});n.create({travelRequest_ID:this.travelId,expenseType:e.expenseType,receiptAmount:e.receiptAmount,receiptDate:e.receiptDate,currency:"INR",attachments:e.attachments||[]});t.submitBatch("travelExpensesGroup").then(()=>{sap.m.MessageToast.show("Travel Expenses saved successfully.");this.getOwnerComponent().getRouter().navTo("ReviewTravelExpensesScreen",{travelId:this.travelId})}).catch(e=>{sap.m.MessageBox.error("Error saving travel request: "+e.message)}).finally(()=>{this.getView().setBusy(false)})})}else{sap.m.MessageToast.show("Please add Travel Expenses.")}},onAttachmentPress:function(e){var t=e.getSource();var n=t.getBindingContext("expenseModel");this._oSelectedContextPath=n.getPath();this._oSelectedExpense=n.getObject();this._oAttachmentBtn=t;if(!this._oAttachmentDialog){var s=new sap.m.VBox({items:[new sap.ui.unified.FileUploader("fileUploader",{width:"100%",sameFilenameAllowed:true,change:this.onFileSelected.bind(this)}),new sap.m.List("attachmentList",{items:{path:"expenseModel>attachments",template:new sap.m.StandardListItem({title:"{expenseModel>name}",description:"{expenseModel>type}"})}})]}).addStyleClass("myDialogContentPadding");this._oAttachmentDialog=new sap.m.Dialog({title:"Upload Attachment",contentWidth:"400px",content:[s],beginButton:new sap.m.Button({text:"Done",press:function(){var e=(this._oSelectedExpense.attachments||[]).length;console.log("iCount-------------");console.log(e);this._oAttachmentBtn.setText(e+(e===1?" Attachment":" Attachments"));var t=this.getOwnerComponent().getModel("expenseModel");t.setProperty(this._oSelectedContextPath+"/attachmentCount",e);this._oAttachmentBtn.rerender();this._oAttachmentDialog.close()}.bind(this)})});this.getView().addDependent(this._oAttachmentDialog)}var o=sap.ui.getCore().byId("attachmentList");o.setBindingContext(n,"expenseModel");this._oAttachmentDialog.open()},onFileSelected:function(e){var t=e.getSource();var n=e.getParameter("files")[0];if(!n||!this._oSelectedExpense){return}var s=new FileReader;s.onload=function(e){var s=e.target.result.split(",")[1];if(!this._oSelectedExpense.attachments){this._oSelectedExpense.attachments=[]}this._oSelectedExpense.attachments.push({name:n.name,type:n.type,size:n.size});this.getOwnerComponent().getModel("expenseModel").refresh(true);t.clear()}.bind(this);s.readAsDataURL(n)},_onRouteMatched:function(e){this.travelId=e.getParameter("arguments").travelId;const t=this.getOwnerComponent().getModel();const n=t.bindContext(`/TravelRequests(${this.travelId})`);n.requestObject().then(e=>{console.log("Single travel request data:",e);const t=new sap.ui.model.json.JSONModel(e);this.getOwnerComponent().setModel(t,"travelData");console.log(t)}).catch(e=>{console.error("Failed to fetch specific travel request:",e);sap.m.MessageBox.error("Error fetching data.")});const s=this.getOwnerComponent().getModel("expenseModel");const o=s.getProperty("/expenses")||[];if(o.length>0){this.byId("idReceiptEntry").setVisible(true);this.byId("expenseTable").setVisible(true)}else{this.byId("idReceiptEntry").setVisible(false);this.byId("expenseTable").setVisible(false)}},onForwardArrowPress:function(e){const t=e.getSource().getBindingContext("travelData");const n=t.getObject();this.travelId=n.ID;this.getOwnerComponent().getRouter().navTo("CreateTravelExpenseScreen",{travelId:travelId})}})});
//# sourceMappingURL=CreateTravelExpenseScreen.controller.js.map